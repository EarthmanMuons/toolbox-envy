#!/usr/bin/env bash
set -euo pipefail

usage() {
	cat >&2 <<'USAGE'
Usage:
  ios-signing-setup

Set up iOS signing in CI from env vars.

Options:
  -h, --help  Show this help message

Required environment variables:
  IOS_SIGNING_CERT_B64          Base64-encoded P12 signing
                               certificate
  IOS_SIGNING_CERT_PASSWORD     Password for the P12
  IOS_PROVISIONING_PROFILE_B64  Base64-encoded .mobileprovision
  IOS_KEYCHAIN_PASSWORD         Password for the ephemeral keychain

Notes:
  In CI (when GITHUB_OUTPUT is set), emits:
    - keychain_path
  If a provisioning profile UUID is available, also emits:
    - provisioning_profile_uuid
    - provisioning_profile_path
USAGE
}

die() {
	printf "ERROR: %s\n" "$*" >&2
	exit 1
}

require_env() {
	local name="$1"
	[[ -n ${!name:-} ]] || die "missing required env var: $name"
}

emit_github_output() {
	local key="$1"
	local value="$2"

	if [[ -n ${GITHUB_OUTPUT:-} ]]; then
		printf '%s=%s\n' "$key" "$value" >>"$GITHUB_OUTPUT"
	fi
}

resolve_repo_root() {
	local root=""

	if [[ -n ${GITHUB_WORKSPACE-} ]]; then
		root="$GITHUB_WORKSPACE"
	elif command -v git >/dev/null 2>&1; then
		root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
	fi

	if [[ -n $root ]]; then
		root="$(cd "$root" && pwd -P)"
	fi

	if [[ -z $root ]]; then
		die "Could not determine repository's top-level directory."
	fi

	printf '%s' "$root"
}

decode_base64() {
	if base64 -D </dev/null >/dev/null 2>&1; then
		base64 -D
	else
		base64 --decode
	fi
}

parse_args() {
	case "${1:-}" in
	"") ;;
	-h | --help)
		usage
		exit 0
		;;
	*)
		usage
		exit 1
		;;
	esac
}

main() {
	parse_args "$@"

	set +x 2>/dev/null || true

	local log_prefix="[ios-signing]"
	printf '%s configuring iOS signing\n' "$log_prefix"

	local repo_root=""
	repo_root="$(resolve_repo_root)"
	cd "$repo_root"

	require_env IOS_SIGNING_CERT_B64
	require_env IOS_SIGNING_CERT_PASSWORD
	require_env IOS_PROVISIONING_PROFILE_B64
	require_env IOS_KEYCHAIN_PASSWORD

	local wwdr_url="https://www.apple.com/certificateauthority/AppleWWDRCAG3.cer"
	local wwdr_cer_filename="AppleWWDRCAG3.cer"

	local IOS_KEYCHAIN_PATH="${RUNNER_TEMP:-/tmp}/ios-signing.keychain-db"
	local IOS_KEYCHAIN_TIMEOUT="21600"

	local tmp_dir=""
	tmp_dir="$(mktemp -d)"
	trap 'rm -rf "'"$tmp_dir"'"' EXIT

	local cert_path="$tmp_dir/signing.p12"
	printf '%s decoding signing cert\n' "$log_prefix"
	umask 077
	printf '%s' "$IOS_SIGNING_CERT_B64" | decode_base64 >"$cert_path"
	chmod 600 "$cert_path"

	local profile_path="$tmp_dir/profile.mobileprovision"
	printf '%s decoding provisioning profile\n' "$log_prefix"
	printf '%s' "$IOS_PROVISIONING_PROFILE_B64" | decode_base64 >"$profile_path"
	chmod 600 "$profile_path"

	if security show-keychain-info "$IOS_KEYCHAIN_PATH" >/dev/null 2>&1; then
		printf '%s deleting existing keychain at %s\n' "$log_prefix" "$IOS_KEYCHAIN_PATH"
		security delete-keychain "$IOS_KEYCHAIN_PATH" || true
	fi
	if [[ -f $IOS_KEYCHAIN_PATH ]]; then
		rm -f "$IOS_KEYCHAIN_PATH"
	fi

	printf '%s creating keychain at %s\n' "$log_prefix" "$IOS_KEYCHAIN_PATH"
	security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$IOS_KEYCHAIN_PATH"
	security set-keychain-settings -lut "$IOS_KEYCHAIN_TIMEOUT" "$IOS_KEYCHAIN_PATH"
	security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$IOS_KEYCHAIN_PATH"

	printf '%s setting keychain as default for this job\n' "$log_prefix"
	security list-keychains -d user -s "$IOS_KEYCHAIN_PATH" /Library/Keychains/System.keychain
	security default-keychain -s "$IOS_KEYCHAIN_PATH"

	emit_github_output "keychain_path" "$IOS_KEYCHAIN_PATH"

	local wwdr_cer="$tmp_dir/$wwdr_cer_filename"

	printf '%s fetching WWDR intermediate (G3)\n' "$log_prefix"
	curl -fsSL -o "$wwdr_cer" "$wwdr_url"

	printf '%s importing WWDR intermediate into keychain\n' "$log_prefix"
	security import "$wwdr_cer" \
		-k "$IOS_KEYCHAIN_PATH" \
		-T /usr/bin/codesign \
		-T /usr/bin/security \
		-T /usr/bin/xcodebuild

	printf '%s importing signing cert into keychain\n' "$log_prefix"
	security import "$cert_path" \
		-k "$IOS_KEYCHAIN_PATH" \
		-P "$IOS_SIGNING_CERT_PASSWORD" \
		-T /usr/bin/codesign \
		-T /usr/bin/security \
		-T /usr/bin/xcodebuild

	printf '%s granting key access to Apple tools\n' "$log_prefix"
	security set-key-partition-list -S apple-tool:,apple: -s \
		-k "$IOS_KEYCHAIN_PASSWORD" "$IOS_KEYCHAIN_PATH"

	printf '%s keychain search list:\n' "$log_prefix"
	security list-keychains -d user
	printf '%s default keychain:\n' "$log_prefix"
	security default-keychain

	if [[ ${IOS_SIGNING_DEBUG:-0} == 1 ]]; then
		printf '%s code signing identities:\n' "$log_prefix"
		security find-identity -v -p codesigning "$IOS_KEYCHAIN_PATH" || true
	fi

	if [[ -n $profile_path ]]; then
		local profiles_dir="$HOME/Library/MobileDevice/Provisioning Profiles"
		mkdir -p "$profiles_dir"

		local profile_plist="$tmp_dir/profile.plist"
		security cms -D -i "$profile_path" >"$profile_plist"
		local profile_uuid=""
		profile_uuid="$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$profile_plist" 2>/dev/null || true)"

		local install_path=""
		if [[ -n $profile_uuid ]]; then
			install_path="$profiles_dir/$profile_uuid.mobileprovision"
		else
			install_path="$profiles_dir/profile.mobileprovision"
		fi

		printf '%s installing provisioning profile to %s\n' "$log_prefix" "$install_path"
		cp -f "$profile_path" "$install_path"
		[[ -f $install_path ]] || die "provisioning profile copy failed: $install_path"
		chmod 600 "$install_path"

		if [[ -n $profile_uuid ]]; then
			emit_github_output "provisioning_profile_uuid" "$profile_uuid"
			emit_github_output "provisioning_profile_path" "$install_path"
		fi
	fi

	if [[ -d ios && -f ios/Runner.xcworkspace/contents.xcworkspacedata ]]; then
		printf '%s diagnostics: build settings (filtered)\n' "$log_prefix" >&2
		if ! (
			cd ios/
			xcodebuild -showBuildSettings \
				-workspace Runner.xcworkspace \
				-scheme Runner \
				-configuration Release | grep -E 'CODE_SIGN_STYLE|PROVISIONING_PROFILE|PROVISIONING_PROFILE_SPECIFIER|CODE_SIGN_IDENTITY|DEVELOPMENT_TEAM' 1>&2
		); then
			printf '%s diagnostics: unable to fetch build settings (non-fatal)\n' "$log_prefix" >&2
		fi
	else
		printf '%s diagnostics: ios/Runner.xcworkspace not found, skipping\n' "$log_prefix" >&2
	fi

	rm -rf "$tmp_dir"
	trap - EXIT

	printf '%s signing configuration ready\n' "$log_prefix"
}

main "$@"
