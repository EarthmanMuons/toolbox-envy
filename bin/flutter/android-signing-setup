#!/usr/bin/env bash
set -euo pipefail

usage() {
	cat >&2 <<'EOF'
Usage:
  android-signing-setup

Prepares Android signing files under ANDROID_SIGNING_DIR (default: ./android):
- <dir>/<keystore filename> (decoded from ANDROID_KEYSTORE_B64 if provided)
- <dir>/key.properties (from env vars)

Required environment variables:
 ANDROID_KEYSTORE_PASSWORD
 ANDROID_KEY_ALIAS
 ANDROID_KEY_PASSWORD

Optional:
 ANDROID_KEYSTORE_B64             Base64-encoded PKCS12/JKS keystore (CI typical)
 ANDROID_KEYSTORE_FILENAME        Default: android-keystore.p12
 ANDROID_SIGNING_DIR              Default: android
 ANDROID_SIGNING_FORCE_DECODE=1   Decode even if keystore file already exists
 ANDROID_SIGNING_ROLE             Log label only (e.g. upload, appsigning)

Notes:
- The generated key.properties uses Gradle's expected keys:
    storeFile, storePassword, keyAlias, keyPassword
EOF
}

[[ $# -eq 0 ]] || {
	usage
	exit 1
}

die() {
	printf "ERROR: %s\n" "$*" >&2
	exit 1
}

require_env() {
	local name="$1"
	[[ -n ${!name:-} ]] || die "missing required env var: $name"
}

repo_root=""
if [[ -n ${GITHUB_WORKSPACE-} ]]; then
	repo_root=$GITHUB_WORKSPACE
else
	if command -v git >/dev/null 2>&1; then
		repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
	fi
fi
[[ -n $repo_root ]] || die "Could not determine repository's top-level directory"

##### MAIN

# Prevent accidental secret echoing if caller enabled xtrace.
set +x 2>/dev/null || true

log_prefix="[android-signing${ANDROID_SIGNING_ROLE:+:${ANDROID_SIGNING_ROLE}}]"
printf '%s configuring Android signing\n' "$log_prefix"

cd "$repo_root"

ANDROID_SIGNING_DIR="${ANDROID_SIGNING_DIR:-android}"

# Guardrail: ensure expected repo root layout.
[[ -d $ANDROID_SIGNING_DIR ]] || die "Expected ./$ANDROID_SIGNING_DIR directory at repo root; are you running from the correct repository?"

ANDROID_KEYSTORE_FILENAME="${ANDROID_KEYSTORE_FILENAME:-android-keystore.p12}"
ANDROID_KEYSTORE_PATH="$ANDROID_SIGNING_DIR/$ANDROID_KEYSTORE_FILENAME"
ANDROID_KEY_PROPERTIES_PATH="$ANDROID_SIGNING_DIR/key.properties"
ANDROID_SIGNING_FORCE_DECODE="${ANDROID_SIGNING_FORCE_DECODE:-}"

decode_base64() {
	# Reads base64 from stdin, writes decoded bytes to stdout.
	# GNU coreutils uses --decode or -d; macOS/BSD uses -D.
	if base64 --help 2>/dev/null | grep -q -- '--decode'; then
		base64 --decode
	elif base64 --help 2>/dev/null | grep -q -- ' -d'; then
		base64 -d
	else
		base64 -D
	fi
}

# If ANDROID_KEYSTORE_B64 is set (CI typical), decode it (unless file already exists).
if [[ -n ${ANDROID_KEYSTORE_B64:-} ]]; then
	if [[ -f $ANDROID_KEYSTORE_PATH && -z $ANDROID_SIGNING_FORCE_DECODE ]]; then
		printf '%s keystore already exists at %s; skipping decode\n' "$log_prefix" "$ANDROID_KEYSTORE_PATH"
	else
		printf '%s decoding keystore to %s\n' "$log_prefix" "$ANDROID_KEYSTORE_PATH"
		umask 077
		printf '%s' "$ANDROID_KEYSTORE_B64" | decode_base64 >"$ANDROID_KEYSTORE_PATH"
		chmod 600 "$ANDROID_KEYSTORE_PATH"
	fi
else
	# Local default: expect keystore already present.
	[[ -f $ANDROID_KEYSTORE_PATH ]] || die "Keystore not found at $ANDROID_KEYSTORE_PATH and ANDROID_KEYSTORE_B64 is not set"
fi

# Write key.properties (required for Gradle signing config).
require_env ANDROID_KEYSTORE_PASSWORD
require_env ANDROID_KEY_ALIAS
require_env ANDROID_KEY_PASSWORD

printf '%s writing %s\n' "$log_prefix" "$ANDROID_KEY_PROPERTIES_PATH"
umask 077

cat >"$ANDROID_KEY_PROPERTIES_PATH" <<EOF
storeFile=$ANDROID_KEYSTORE_FILENAME
storePassword=$ANDROID_KEYSTORE_PASSWORD
keyAlias=$ANDROID_KEY_ALIAS
keyPassword=$ANDROID_KEY_PASSWORD
EOF

chmod 600 "$ANDROID_KEY_PROPERTIES_PATH"

printf '%s signing configuration ready\n' "$log_prefix"
