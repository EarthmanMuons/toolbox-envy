#!/usr/bin/env bash
set -euo pipefail

usage() {
	cat >&2 <<'USAGE'
Usage:
  create-checksums [--dir <dir>]

Create sha256sums.txt for all regular files in a directory.

Options:
  -d, --dir <dir>  Directory containing the assets (default: dist)
  -h, --help       Show this help message
USAGE
}

die() {
	printf "ERROR: %s\n" "$*" >&2
	exit 1
}

# Defaults (populated/overridden by parse_args)
dist_dir="dist"

parse_args() {
	while (($#)); do
		case "$1" in
		-d | --dir)
			shift
			dist_dir="${1-}"
			[[ -n $dist_dir ]] || die "--dir requires a value"
			;;
		-h | --help)
			usage
			exit 0
			;;
		*) die "Unknown argument: $1" ;;
		esac
		shift
	done
}

validate_inputs() {
	[[ -d $dist_dir ]] || die "Dist directory not found: $dist_dir"
}

# Outputs:
#   sets global FILES (filenames only)
collect_files() {
	FILES=()

	local f base
	shopt -s nullglob
	for f in "$dist_dir"/*; do
		[[ -f $f ]] || continue
		base="${f##*/}"
		[[ $base == "sha256sums.txt" ]] && continue
		FILES+=("$base")
	done
	shopt -u nullglob

	((${#FILES[@]} > 0)) || die "No files found in: $dist_dir"
}

write_checksums() {
	# Output format must remain: "<hash><two spaces><filename>" (GNU sha256sum compatible)
	if command -v sha256sum >/dev/null 2>&1; then
		(
			cd "$dist_dir"
			LC_ALL=C printf '%s\n' "${FILES[@]}" | sort | while IFS= read -r f; do
				sha256sum -- "$f"
			done >sha256sums.txt
		)
	elif command -v shasum >/dev/null 2>&1; then
		(
			cd "$dist_dir"
			LC_ALL=C printf '%s\n' "${FILES[@]}" | sort | while IFS= read -r f; do
				shasum -a 256 -- "$f"
			done >sha256sums.txt
		)
	else
		die "Need sha256sum or shasum to generate SHA-256 checksums."
	fi
}

main() {
	parse_args "$@"
	validate_inputs
	collect_files
	write_checksums

	printf "wrote %s/sha256sums.txt for %s file(s)\n" "$dist_dir" "${#FILES[@]}" >&2
}

main "$@"
