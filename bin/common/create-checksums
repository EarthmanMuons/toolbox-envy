#!/usr/bin/env bash
set -euo pipefail

usage() {
	cat >&2 <<'USAGE'
Usage:
  create-checksums [--dir <dir>]

Create sha256sums.txt for all regular files in the assets directory.

Options:
  -d, --dir   Directory containing the assets (default: dist)
  -h, --help  Show this help message.
USAGE
}

die() {
	printf "ERROR: %s\n" "$*" >&2
	exit 1
}

dist_dir="dist"

while (($#)); do
	case "$1" in
	-d | --dir)
		shift
		dist_dir="${1-}"
		[[ -n $dist_dir ]] || die "--dir requires a value"
		;;
	-h | --help)
		usage
		exit 0
		;;
	*) die "Unknown argument: $1" ;;
	esac
	shift
done

[[ -d $dist_dir ]] || die "Dist directory not found: $dist_dir"

pushd "$dist_dir" >/dev/null
trap 'popd >/dev/null || true' EXIT

files=()
for f in *; do
	[[ -f $f ]] || continue
	[[ $f == "sha256sums.txt" ]] && continue
	files+=("$f")
done

((${#files[@]} > 0)) || die "No files found in: $dist_dir"

# Output format must remain: "<hash><two spaces><filename>" (GNU sha256sum compatible)
if command -v sha256sum >/dev/null 2>&1; then
	LC_ALL=C printf '%s\n' "${files[@]}" | sort | while IFS= read -r f; do
		sha256sum -- "$f"
	done >sha256sums.txt
elif command -v shasum >/dev/null 2>&1; then
	LC_ALL=C printf '%s\n' "${files[@]}" | sort | while IFS= read -r f; do
		shasum -a 256 -- "$f"
	done >sha256sums.txt
else
	die "Need sha256sum or shasum to generate SHA-256 checksums."
fi

printf "wrote %s/sha256sums.txt for %s file(s)\n" "$dist_dir" "${#files[@]}" >&2
