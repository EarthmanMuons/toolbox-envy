#!/usr/bin/env bash
set -euo pipefail

usage() {
	cat >&2 <<'USAGE'
Usage:
  shotproc [--width N] [--quality Q] <input> [output]

Process a screenshot: optional resize, strip metadata, set output quality.

Options:
  -w, --width N     Resize to width N (px), keeping aspect ratio
  -q, --quality Q   Output quality for lossy formats (WebP/JPEG) (default: 90)
  -h, --help        Show this help message
USAGE
}

die() {
	printf "ERROR: %s\n" "$*" >&2
	exit 1
}

need_cmd() {
	command -v "$1" >/dev/null 2>&1 || die "Required command not found in PATH: $1"
}

# Defaults (populated/overridden by parse_args)
WIDTH=""
QUALITY="90"

parse_args() {
	positional=()

	while [[ $# -gt 0 ]]; do
		case "$1" in
		-w | --width)
			[[ $# -ge 2 ]] || die "--width requires a value"
			WIDTH="$2"
			shift 2
			;;
		-q | --quality)
			[[ $# -ge 2 ]] || die "--quality requires a value"
			QUALITY="$2"
			shift 2
			;;
		-h | --help)
			usage
			exit 0
			;;
		--)
			shift
			break
			;;
		-*)
			die "Unknown option: $1"
			;;
		*)
			positional+=("$1")
			shift
			;;
		esac
	done

	if [[ $# -gt 0 ]]; then
		positional+=("$@")
	fi
}

validate_inputs() {
	if [[ ${#positional[@]} -lt 1 || ${#positional[@]} -gt 2 ]]; then
		usage
		exit 1
	fi
}

main() {
	parse_args "$@"
	validate_inputs

	local in_file="${positional[0]}"
	local out_file="${positional[1]:-processed.webp}"

	[[ -f $in_file ]] || die "file not found: $in_file"
	need_cmd magick

	declare -a resize_args=()
	if [[ -n $WIDTH ]]; then
		resize_args=(-resize "${WIDTH}x")
	fi

	magick "$in_file" \
		${resize_args[@]+"${resize_args[@]}"} \
		-strip \
		-quality "$QUALITY" \
		"$out_file"

	echo "Wrote $out_file"
}

main "$@"
