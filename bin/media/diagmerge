#!/usr/bin/env bash
set -euo pipefail

usage() {
	cat >&2 <<'USAGE'
Usage:
  diagmerge [--width N] [--feather S] [--quality Q] <image1> <image2> [output]

Create a diagonal merge: upper-left from image1, lower-right from image2.

Options:
  -w, --width N     Resize both inputs to width N (px), keeping aspect ratio
  -f, --feather S   Feather sigma (px) for the diagonal edge (default: 0.8)
  -q, --quality Q   Output quality for lossy formats (WebP/JPEG) (default: 90)
  -h, --help        Show this help message
USAGE
}

die() {
	printf "ERROR: %s\n" "$*" >&2
	exit 1
}

need_cmd() {
	command -v "$1" >/dev/null 2>&1 || die "Required command not found in PATH: $1"
}

# Defaults (populated/overridden by parse_args)
WIDTH=""
FEATHER="0.8"
QUALITY="90"

parse_args() {
	positional=()

	while [[ $# -gt 0 ]]; do
		case "$1" in
		-w | --width)
			[[ $# -ge 2 ]] || die "--width requires a value"
			WIDTH="$2"
			shift 2
			;;
		-f | --feather)
			[[ $# -ge 2 ]] || die "--feather requires a value"
			FEATHER="$2"
			shift 2
			;;
		-q | --quality)
			[[ $# -ge 2 ]] || die "--quality requires a value"
			QUALITY="$2"
			shift 2
			;;
		-h | --help)
			usage
			exit 0
			;;
		--)
			shift
			break
			;;
		-*)
			die "Unknown option: $1"
			;;
		*)
			positional+=("$1")
			shift
			;;
		esac
	done

	if [[ $# -gt 0 ]]; then
		positional+=("$@")
	fi
}

validate_inputs() {
	if [[ ${#positional[@]} -lt 2 || ${#positional[@]} -gt 3 ]]; then
		usage
		exit 1
	fi
}

main() {
	parse_args "$@"
	validate_inputs

	local img1="${positional[0]}"
	local img2="${positional[1]}"
	local out="${positional[2]:-diagonal.webp}"

	for f in "$img1" "$img2"; do
		[[ -f $f ]] || die "file not found: $f"
	done

	need_cmd magick

	local w1 h1 w2 h2
	w1="$(magick identify -ping -format "%w" "$img1")"
	h1="$(magick identify -ping -format "%h" "$img1")"
	w2="$(magick identify -ping -format "%w" "$img2")"
	h2="$(magick identify -ping -format "%h" "$img2")"

	if [[ $w1 != "$w2" || $h1 != "$h2" ]]; then
		die "images must be the same size ($img1: ${w1}x${h1}, $img2: ${w2}x${h2})"
	fi

	declare -a resize_args=()
	local w="$w1"
	local h="$h1"

	if [[ -n $WIDTH ]]; then
		resize_args=(-resize "${WIDTH}x")
		w="$(magick "$img1" ${resize_args[@]+"${resize_args[@]}"} -ping -format "%w" info:)"
		h="$(magick "$img1" ${resize_args[@]+"${resize_args[@]}"} -ping -format "%h" info:)"
	fi

	magick \
		\( "$img2" ${resize_args[@]+"${resize_args[@]}"} \) \
		\( "$img1" ${resize_args[@]+"${resize_args[@]}"} -alpha set \
		\( -size "${w}x${h}" xc:none -fill white \
		-draw "polygon 0,0 0,${h} ${w},0" \
		-blur "0x${FEATHER}" \
		\) \
		-compose DstIn -composite \
		\) \
		-compose Over -composite \
		-strip \
		-quality "$QUALITY" \
		"$out"

	echo "Wrote $out"
}

main "$@"
