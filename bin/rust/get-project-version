#!/usr/bin/env bash
set -euo pipefail

usage() {
	cat >&2 <<'USAGE'
Usage:
  get-project-version [<package-name>]

Read the Rust package version via cargo metadata.

Options:
  -h, --help  Show this help message
USAGE
}

die() {
	printf "ERROR: %b\n" "$*" >&2
	exit 1
}

need_cmd() {
	command -v "$1" >/dev/null 2>&1 || die "Required command not found in PATH: $1"
}

resolve_repo_root() {
	local root=""

	if [[ -n ${GITHUB_WORKSPACE-} ]]; then
		root="$GITHUB_WORKSPACE"
	elif command -v git >/dev/null 2>&1; then
		root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
	fi

	if [[ -n $root ]]; then
		root="$(cd "$root" && pwd -P)"
	fi

	if [[ -z $root ]]; then
		die "Could not determine repository's top-level directory."
	fi

	printf '%s' "$root"
}

find_manifest() {
	local repo_root="$1"
	local current_dir=""
	current_dir="$(pwd -P)"
	local dir="$current_dir"

	while :; do
		if [[ -f "$dir/Cargo.toml" ]]; then
			printf '%s' "$dir/Cargo.toml"
			return 0
		fi
		if [[ -n $repo_root && $dir == "$repo_root" ]]; then
			break
		fi
		local parent=""
		parent="$(cd "$dir/.." && pwd -P)"
		if [[ $parent == "$dir" ]]; then
			break
		fi
		dir="$parent"
	done

	printf ''
}

# Defaults (populated/overridden by parse_args)
package_name=""

parse_args() {
	case "${1:-}" in
	-h | --help)
		usage
		exit 0
		;;
	esac

	[[ $# -le 1 ]] || {
		usage
		die "expected at most one argument: <package-name>"
	}

	package_name="${1:-}"

	if [[ -z $package_name && ! -t 0 ]]; then
		IFS= read -r package_name || true
		package_name="${package_name//$'\r'/}"
		package_name="$(printf '%s' "$package_name" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//')"
	fi
}

main() {
	parse_args "$@"

	need_cmd cargo
	need_cmd jq

	local repo_root=""
	repo_root="$(resolve_repo_root)"

	local manifest=""
	manifest="$(find_manifest "$repo_root")"
	[[ -n $manifest ]] || die "Cargo.toml not found between $(pwd -P) and $repo_root."

	local metadata=""
	metadata="$(cargo metadata --no-deps --format-version=1 --manifest-path "$manifest")"

	if [[ -z $package_name ]]; then
		local pkg_count=""
		pkg_count="$(jq -r '.packages | length' <<<"$metadata")"
		if [[ $pkg_count == "1" ]]; then
			package_name="$(jq -r '.packages[0].name' <<<"$metadata")"
		else
			local pkg_list=""
			pkg_list="$(jq -r '.packages[].name' <<<"$metadata" | sort)"
			die "multiple packages detected; please provide <package-name>. Available packages:\n$pkg_list"
		fi
	fi

	local version=""
	version="$(
		jq -r --arg pkg "$package_name" '
        .packages[]
        | select(.name == $pkg)
        | .version
      ' <<<"$metadata" | head -n 1
	)"

	[[ -n $version ]] || die "Package '$package_name' not found in cargo metadata"

	printf '%s\n' "$version"
}

main "$@"
