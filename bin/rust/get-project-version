#!/usr/bin/env bash
set -euo pipefail

usage() {
	cat >&2 <<'EOF'
Usage:
  get-project-version [<package-name>]

Reads the version for a Rust package in the current repository using `cargo metadata`.

Examples:
  get-project-version my-crate
  get-project-version
  echo my-crate | get-project-version
EOF
}

die() {
	printf "ERROR: %b\n" "$*" >&2
	exit 1
}

main() {
	if [[ ${1:-} == "-h" || ${1:-} == "--help" ]]; then
		usage
		exit 0
	fi

	[[ $# -le 1 ]] || {
		usage
		die "expected at most one argument: <package-name>"
	}

	local pkg="${1:-}"
	if [[ -z $pkg && ! -t 0 ]]; then
		IFS= read -r pkg || true
		pkg="${pkg//$'\r'/}"
		pkg="$(printf '%s' "$pkg" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//')"
	fi

	command -v cargo >/dev/null 2>&1 || die "cargo is required"
	command -v jq >/dev/null 2>&1 || die "jq is required"

	local repo_root=""
	if [[ -n ${GITHUB_WORKSPACE-} ]]; then
		repo_root=$GITHUB_WORKSPACE
	else
		if command -v git >/dev/null 2>&1; then
			repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
		fi
	fi
	if [[ -n $repo_root ]]; then
		repo_root="$(cd "$repo_root" && pwd -P)"
	fi

	local manifest=""
	local current_dir=""
	current_dir="$(pwd -P)"
	local dir="$current_dir"
	while :; do
		if [[ -f "$dir/Cargo.toml" ]]; then
			manifest="$dir/Cargo.toml"
			break
		fi
		if [[ -n $repo_root && $dir == "$repo_root" ]]; then
			break
		fi
		local parent=""
		parent="$(cd "$dir/.." && pwd -P)"
		if [[ $parent == "$dir" ]]; then
			break
		fi
		dir="$parent"
	done

	[[ -n $manifest ]] || die "Cargo.toml not found between $current_dir and ${repo_root:-filesystem root}."

	local metadata=""
	metadata="$(cargo metadata --no-deps --format-version=1 --manifest-path "$manifest")"

	if [[ -z $pkg ]]; then
		local pkg_count=""
		pkg_count="$(jq -r '.packages | length' <<<"$metadata")"
		if [[ $pkg_count == "1" ]]; then
			pkg="$(jq -r '.packages[0].name' <<<"$metadata")"
		else
			local pkg_list=""
			pkg_list="$(jq -r '.packages[].name' <<<"$metadata" | sort)"
			die "multiple packages detected; please provide <package-name>. Available packages:\n$pkg_list"
		fi
	fi

	local version=""
	version="$(
		jq -r --arg pkg "$pkg" '
        .packages[]
        | select(.name == $pkg)
        | .version
      ' <<<"$metadata" | head -n 1
	)"

	[[ -n $version ]] || die "Package '$pkg' not found in cargo metadata"

	printf '%s\n' "$version"
}

main "$@"
